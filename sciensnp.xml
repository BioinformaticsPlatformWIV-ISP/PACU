<tool id="sciensnp" name="ScienSNP phylogeny" version="0.0.1">
    <description>Workflow for whole genome sequencing based phylogeny of Illumina and ONT R9/R10 data.</description>
    <command>
        <![CDATA[
        $__tool_directory__/run_sciensnp.sh

        ## Input files
        --ref-fasta $input.reference
        --ref-fasta-name "$input.reference.name"

        #for $bam in $input.bam_ilmn:
            #if $bam:
                --bam-ilmn $bam "$bam.name"
            #end if
        #end for

        #for $bam in $input.bam_ont:
            #if $bam:
                --bam-ont $bam "$bam.name"
            #end if
        #end for

        ## Phages
        #if str($input.mask_phages.mask_phages_selector) == 'yes':
            --ref-bed $input.mask_phages.bed_phages
        #end if

        ## Tree building method
        #if $params.tree_method == 'mega':
            --use-mega
        #end if

        ## Output files
        --output-html "$html"
        --output "$html.files_path"

        ## Variant filters
        --min-snp-af $filtering.af
        --min-snp-qual $filtering.qual
        --min-snp-depth $filtering.dp
        --min-snp-dist $filtering.dist
        ]]>
    </command>
    <inputs>
        <!-- Input files -->
        <section name="input" title="Input files" expanded="true">
            <param name="reference" type="data" format="fasta" label="Reference genome"/>
            <param name="bam_ilmn" type="data" format="bam" multiple="true" optional="true" label="BAM files (Illumina)"
                   help="Make sure the reads are mapped to the reference selected above."/>
            <param name="bam_ont" type="data" format="bam" multiple="true" optional="true" label="BAM files (ONT)"
                   help="Make sure the reads are mapped to the reference selected above."/>
            <conditional name="mask_phages">
                <param name="mask_phages_selector" type="select" label="Mask (pro-)phage regions">
                    <option value="no" selected="true">No</option>
                    <option value="yes">Yes</option>
                </param>
                <when value="yes">
                    <param name="bed_phages" type="data" format="bed" label="BED file with (pro-)phage regions in the reference genome"/>
                </when>
                <when value="no"/>
            </conditional>
        </section>

        <!-- Parameters -->
        <section name="params" title="Parameters" expand="False">
            <param name="tree_method" type="select" label="Tree building method">
                <option value="iqtree">IQ-TREE</option>
                <option value="mega" selected="true">MEGA X</option>
            </param>
            <param name="min_depth" type="integer" label="Min. global depth" value="5" min="0" max="100"
                   help="Minimum depth across all samples for a position to be included in the SNP analysis." />
        </section>

        <!-- Variant filtering -->
        <section name="filtering" title="Variant filters" expanded="false">
            <param name="af" type="float" value="0.66" min="0.0" max="1.0" label="Min. allele frequency"/>
            <param name="dp" type="integer" value="5" min="0" label="Min. depth"/>
            <param name="qual" type="integer" value="50" min="0" max="255" label="Min. SNP quality"/>
            <param name="dist" type="integer" value="10" min="0" max="100" label="Min. distance between SNPs"/>
        </section>
    </inputs>

    <outputs>
        <data name="html" format="html" label="ScienSNP (${input.reference.name})" />
    </outputs>

     <stdio>
        <exit_code range="1:" level="fatal" />
    </stdio>
</tool>